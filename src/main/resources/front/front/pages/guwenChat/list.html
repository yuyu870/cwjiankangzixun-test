<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../elementui/elementui.css" />
    <style>
        html,body,#vue {
            height: 100%;
        }
        body {
            margin: 0;
        }
        .chat-form {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .chat-content {
            overflow-y: scroll;
            border: 1px solid #eeeeee;
            margin: 0;
            padding: 0;
            width: 100%;
            flex: 1;
        }
        .left-content {
            float: left;
            margin-bottom: 10px;
            padding: 10px;
        }
        .right-content {
            float: right;
            margin-bottom: 10px;
            padding: 10px;
        }
        .clear-float {
            clear: both;
        }
        .btn-input {
            margin-left: 0px;
            display: flex;
            width: 100%;
            padding: 10px 12px;
            box-sizing: border-box;
        }
        .message-bubble {
            max-width: 70%;
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
        }
        .user-message {
            background-color: #95ec69;
            border-bottom-right-radius: 0;
            margin-left: auto;
        }
        .ai-message {
            background-color: #f0f9ff;
            border-bottom-left-radius: 0;
            margin-right: auto;
        }
        .guwen-message {
            background-color: #fff7e6;
            border-bottom-left-radius: 0;
            margin-right: auto;
        }
        .message-content {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message-time {
            font-size: 12px;
            color: #999;
            text-align: right;
        }
        .message-source {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body style="overflow-y: hidden;overflow-x: hidden;">
<div id="vue">
    <el-form class="detail-form-content chat-form" ref="ruleForm" label-width="0">
        <div class="chat-content">
            <div v-bind:key="item.id" v-for="item in dataList">
                <div v-if="item.guwenChatIssueText" class="right-content">
                    <div class="message-bubble user-message">
                        <div class="message-content">{{ item.guwenChatIssueText }}</div>
                        <div class="message-time">{{ item.issueTime }}</div>
                    </div>
                </div>
                <div v-if="item.guwenChatReplyText" class="left-content">
                    <div class="message-bubble" :class="item.replySourceTypes === 1 ? 'ai-message' : 'guwen-message'">
                        <div class="message-source">{{ item.replySourceTypes === 1 ? 'AI客服' : '顾问回复' }}</div>
                        <div class="message-content">{{ item.guwenChatReplyText }}</div>
                        <div class="message-time">{{ item.replyTime }}</div>
                    </div>
                </div>
                <div class="clear-float"></div>
            </div>
        </div>
        <div class="btn-input" style="display:flex;flex-direction: column">
            <div style="display:flex">
                <el-input style="flex: 1;margin-right: 10px;" v-model="ruleForm.guwenChatIssueText" placeholder="发布" style="margin-right: 10px;" clearable></el-input>
                <el-button type="primary" @click="onSubmit">发布</el-button>
            </div>
        </div>
    </el-form>
</div>

<!-- layui -->
<script src="../../layui/layui.js"></script>
<!-- vue -->
<script src="../../js/vue.js"></script>
<!-- elementui -->
<script src="../../elementui/elementui.js"></script>
<!-- 组件配置信息 -->
<script src="../../js/config.js"></script>
<!-- 扩展插件配置信息 -->
<script src="../../modules/config.js"></script>
<!-- 工具方法 -->
<script src="../../js/utils.js"></script>
<script type="text/javascript">
    var vue = new Vue({
        el: "#vue",
        data() {
            return {
                id: "",
                //项目路径
                baseUrl:"",
                ruleForm: {},
                dataList: [],
                inter: null,
            }
        },
        methods: {
            // 初始化
            init(id) {
                this.getList();
                this.id = id;
                var that = this;
                that.getList();
                var inter = setInterval(function() {
                    that.getList();
                }, 10000)
                this.inter = inter;
            },
            getList() {
                let data = {
                    yonghuId: localStorage.getItem('userid'),//询问人
                    guwenId:layui.http.getParam('guwenId'),//被咨询人
                    order:'asc',
                    limit: '100000000',
                }
                layui.http.request('guwenChat/page', 'get', data, (res) => {
                    this.dataList = res.data.list;
                })
            },
            // 提交
            onSubmit() {
                let _this = this
                if (!_this.ruleForm.guwenChatIssueText) {
                    layer.msg('请输入咨询内容', {
                        time: 2000,
                        icon: 5
                    });
                    return
                }

                layer.load(2);

                layui.http.requestJson('guwenChat/add', 'post', {
                    yonghuId: localStorage.getItem('userid'),//询问人
                    guwenChatIssueText: _this.ruleForm.guwenChatIssueText,
                    guwenChatTypes: 1,
                    zhuangtaiTypes: 1,
                    guwenId: layui.http.getParam('guwenId'),//被询问人
                    issueTime: getCurDateTime(),
                }, (res) => {
                    layer.closeAll('loading');
                    if(res.code === 0) {
                        _this.ruleForm.guwenChatIssueText="";
                        _this.ruleForm.guwenChatIssuePhoto=null;
                        _this.getList();
                        layer.msg('AI已回复您的咨询', {
                            time: 2000,
                            icon: 6
                        });
                    } else {
                        layer.msg(res.msg, {
                            time: 3000,
                            icon: 5
                        });
                    }
                }, (error) => {
                    layer.closeAll('loading');
                    layer.msg('网络错误，请稍后重试', {
                        time: 3000,
                        icon: 5
                    });
                });
            }
        }
    })

    layui.use(['layer', 'element', 'http', 'jquery', 'upload'], function() {
        var layer = layui.layer;
        var element = layui.element;
        var http = layui.http;
        var jquery = layui.jquery;
        vue.baseUrl = http.baseurl;
        var upload = layui.upload;
        vue.init();
    });
</script>
</body>
</html>
